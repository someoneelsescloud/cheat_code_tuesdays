parameters:
- name: assetname
  type: string
  default: false
- name: environment
  type: string
  default: false
- name: location
  type: string
  default: false
# https://docs.microsoft.com/en-us/azure/devops/pipelines/process/templates?view=azure-devops

steps:
- task: TerraformInstaller@0
  displayName: Install Terraform
  inputs:
    terraformVersion: 'latest'
- task: TerraformCLI@0
  displayName: Terraform init
  inputs:
    command: 'init'
    backendType: 'azurerm'
    backendServiceArm: 'terraform-sp-63498'
    ensureBackend: true
    backendAzureRmResourceGroupName: '${{ parameters.assetname}}-${{ parameters.environment}}-${{ parameters.location}}-rg-1'
    backendAzureRmResourceGroupLocation: '${{ parameters.location}}'
    backendAzureRmStorageAccountName: '${{ parameters.assetname}}storageacc0011'
    backendAzureRmStorageAccountSku: 'Standard_LRS'
    backendAzureRmContainerName: 'tfstates'
    backendAzureRmKey: '${{ parameters.environment}}-tfstate'
    allowTelemetryCollection: false
    commandOptions: '-var assetname=${{ parameters.assetname}} -var environment=${{ parameters.environment}} -var location=${{ parameters.location}}'
    workingDirectory: '$(System.DefaultWorkingDirectory)/04_azure_pipeline_templates'
- task: TerraformCLI@0
  displayName: Terraform validate
  inputs:
    command: 'validate'
    environmentServiceName: 'terraform-sp-63498'
    allowTelemetryCollection: false
    workingDirectory: '$(System.DefaultWorkingDirectory)/04_azure_pipeline_templates'
- task: TerraformCLI@0
  displayName: Terraform plan
  inputs:
    command: 'plan'
    environmentServiceName: 'terraform-sp-63498'
    allowTelemetryCollection: false
    commandOptions: '-var assetname=${{ parameters.assetname}} -var environment=${{ parameters.environment}} -var location=${{ parameters.location}}'
    workingDirectory: '$(System.DefaultWorkingDirectory)/04_azure_pipeline_templates'    
- task: TerraformCLI@0
  displayName: Terraform apply
  inputs:
    command: 'apply'
    environmentServiceName: 'terraform-sp-63498'
    commandOptions: '-var assetname=${{ parameters.assetname}} -var environment=${{ parameters.environment}} -var location=${{ parameters.location}}'
    allowTelemetryCollection: false
